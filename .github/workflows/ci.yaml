name: CI
on:
  push:
    branches:
      - release-*
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build (leave empty for current branch)'
        required: false
        default: ''
      publish:
        description: 'Publish Docker images?'
        required: true
        type: choice
        default: 'true'
        options:
          - 'true'
          - 'false'

env:
  golang-version: '1.23'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
jobs:
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit tests
    steps:
      - uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac
      - uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed
        with:
          go-version-file: 'go.mod'
      - run: make test
  build-docker:
    runs-on: ubuntu-latest
    name: Build and Push Docker image
    permissions:
      contents: write
      packages: write
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set version environment variable
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual workflow: use short SHA, publish based on input
            SHORT_SHA=$(git rev-parse --short HEAD)
            echo "VERSION=${SHORT_SHA}" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=false" >> $GITHUB_ENV
            echo "GITHUB_RELEASE=false" >> $GITHUB_ENV
            echo "SHOULD_PUBLISH=${{ github.event.inputs.publish }}" >> $GITHUB_ENV
            
            # Create local tag for GoReleaser (if publishing)
            if [ "${{ github.event.inputs.publish }}" = "true" ]; then
              LOCAL_TAG="v0.0.0-manual.${SHORT_SHA}"
              git tag "${LOCAL_TAG}"
              echo "Created local tag: ${LOCAL_TAG}"
            fi
            
            echo "Manual build - VERSION=${SHORT_SHA}, PUBLISH=${{ github.event.inputs.publish }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            # Tag release: use tag name, publish everything
            VERSION="${{ github.ref_name }}"
            echo "VERSION=${VERSION}" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=true" >> $GITHUB_ENV
            echo "GITHUB_RELEASE=true" >> $GITHUB_ENV
            echo "SHOULD_PUBLISH=true" >> $GITHUB_ENV
            echo "Tag release - VERSION=${VERSION}"
          else
            # PR/branch: use short SHA, don't publish
            VERSION=$(git rev-parse --short HEAD)
            echo "VERSION=${VERSION}" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=false" >> $GITHUB_ENV
            echo "GITHUB_RELEASE=false" >> $GITHUB_ENV
            echo "SHOULD_PUBLISH=false" >> $GITHUB_ENV
            echo "PR/Branch build - VERSION=${VERSION}"
          fi

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@9ed2f89a662bf1735a48bc8557fd212fa902bebf # v6.1.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: ${{ env.SHOULD_PUBLISH == 'true' && 'release' || 'release --snapshot --skip=publish' }} --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ env.VERSION }}
          PUBLISH_LATEST: ${{ env.PUBLISH_LATEST }}
          GITHUB_RELEASE: ${{ env.GITHUB_RELEASE }}
      
      - name: Build Summary
        if: always()
        run: |
          echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Published:** ${{ env.SHOULD_PUBLISH }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.SHOULD_PUBLISH }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Docker Images:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/zama-ai/blockchain-wallet-exporter/blockchain-wallet-exporter:${{ env.VERSION }}\` (multi-arch)" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/zama-ai/blockchain-wallet-exporter/blockchain-wallet-exporter:${{ env.VERSION }}-amd64\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/zama-ai/blockchain-wallet-exporter/blockchain-wallet-exporter:${{ env.VERSION }}-arm64\`" >> $GITHUB_STEP_SUMMARY
            if [ "${{ env.PUBLISH_LATEST }}" = "true" ]; then
              echo "- \`ghcr.io/zama-ai/blockchain-wallet-exporter/blockchain-wallet-exporter:latest\` (multi-arch)" >> $GITHUB_STEP_SUMMARY
            fi
          fi